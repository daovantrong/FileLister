version: '3.8'

# ============================================================
# FileLister – Production Docker Compose
# Security-hardened configuration aligned with index.php fixes
# ============================================================

services:
  filelister:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: filelister

    # ── Port binding ──────────────────────────────────────
    # Bind to localhost only; put Nginx/Caddy in front for TLS.
    # Change to "0.0.0.0:8080:80" only if no reverse proxy.
    ports:
      - "127.0.0.1:8080:80"

    # ── Environment variables ─────────────────────────────
    # Values here override defaults in index.php config.
    # Sensitive values should come from a real .env file
    # (not committed to version control).
    env_file:
      - .env           # copy from .env.example; never commit secrets
    environment:
      # VUL-03 FIX: Force production mode even if .env omits it
      APP_ENV: production
      ENABLE_DEV: "false"

      # VUL-07 FIX: Strong hash algorithms only
      ENABLE_HASHTYPE: "CRC32,XXH128,SHA-256,SHA3-256"

      # VUL-02 FIX: Trusted proxy IPs (comma-separated).
      # Set to the actual IP of your reverse proxy / load balancer.
      # Leave empty ("") if running without a proxy.
      TRUSTED_PROXIES: ""

      # PHP error log destination (matches php.ini in Dockerfile)
      PHP_ERROR_LOG: /var/log/apache2/php_error.log

    # ── Volumes ────────────────────────────────────────────
    # ⚠  DO NOT mount the full source tree (.) into /var/www/html
    #    in production – it exposes .env, build.php, Dockerfile, etc.
    #    Instead, bind-mount ONLY the folder(s) users should browse.
    volumes:
      # The directory you want FileLister to list (read-only)
      - type: bind
        source: ./files          # ← create this folder; put shared files here
        target: /var/www/html/files
        read_only: true

      # Writable temp storage for rate-limit counters and hash cache
      # Using tmpfs keeps them in RAM (fast) and ephemeral (no disk leaks)
      - type: tmpfs
        target: /tmp
        tmpfs:
          size: "64m"
          mode: 0770

      # Named volume for PHP session storage (optional; FileLister is sessionless)
      # - sessions:/var/lib/php/sessions

    # ── Runtime security options ─────────────────────────
    security_opt:
      # Prevent privilege escalation inside the container
      - no-new-privileges:true
    # Drop ALL Linux capabilities; add back only what Apache needs
    cap_drop:
      - ALL
    cap_add:
      - CHOWN        # set ownership during startup
      - SETUID       # Apache drops from root → www-data
      - SETGID
      - NET_BIND_SERVICE  # bind port 80

    # ── Read-only root filesystem ─────────────────────────
    # Everything the app needs to write goes through the
    # tmpfs mount above. The image itself is immutable.
    read_only: true

    # Writable runtime directories required by Apache/PHP
    # (pid files, lock files, apache cache)
    tmpfs:
      - /run/apache2:size=8m,mode=0770
      - /var/log/apache2:size=32m,mode=0770
      - /var/cache/apache2:size=16m,mode=0770

    # ── Resource limits ───────────────────────────────────
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 256M
        reservations:
          memory: 64M

    # ── Health check ─────────────────────────────────────
    healthcheck:
      test: ["CMD", "curl", "-fsSo", "/dev/null", "http://localhost/"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

    restart: unless-stopped

# ── Named volumes ─────────────────────────────────────────
# volumes:
#   sessions:
